<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Admin - Bestride</title>
  <style>
    body{font-family:Arial,sans-serif;margin:20px;max-width:1000px}
    h1{margin:0 0 10px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ccc;padding:8px;text-align:left}
    th{background:#f3f3f3}
    button{padding:6px 10px;cursor:pointer;border:none;border-radius:6px}
    .pending{background:#fff3cd}
    .assigned{background:#d1e7dd}
    .declined{background:#f8d7da}
    .completed{background:#e2e3e5}
  </style>
</head>
<body>
  <h1>Panel de Administración - Viajes pendientes</h1>
  <p>Actualiza el estado de cada reserva.</p>

  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th><th>Nombre</th><th>Origen</th><th>Destino</th>
        <th>Teléfono</th><th>Fecha</th><th>Hora</th><th>Status</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadBookings() {
      const resp = await fetch("/api/bookings", { cache: "no-store" });
      if (!resp.ok) {
        alert("No autorizado o error cargando reservas.");
        return;
      }
      const list = await resp.json();
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      list.sort((a,b)=>b.id-a.id).forEach(b => {
        const tr = document.createElement("tr");
        tr.className = b.status;
        tr.innerHTML = `
          <td>${b.id}</td>
          <td>${b.name||""}</td>
          <td>${b.origin||""}</td>
          <td>${b.destination||""}</td>
          <td>${b.phone||""}</td>
          <td>${b.date||""}</td>
          <td>${b.time||""}</td>
          <td><b>${b.status}</b></td>
          <td>
            <button onclick="setStatus(${b.id}, 'assigned')">Asignar</button>
            <button onclick="setStatus(${b.id}, 'declined')">Rechazar</button>
            <button onclick="setStatus(${b.id}, 'completed')">Completado</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function setStatus(id, status) {
      const resp = await fetch(`/api/bookings/${id}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });
      if (resp.ok) {
        loadBookings();
      } else {
        alert("Error actualizando estado.");
      }
    }

    loadBookings();
    setInterval(loadBookings, 15000); // refresca cada 15s
  </script>
</body>
</html>
